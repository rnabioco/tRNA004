---
title: "BCerror_plots"
author: "Laura White"
date: "2024-01-13"
output: html_document
---
```{r global options, include = FALSE}
knitr::opts_chunk$set(message=FALSE)
library(tidyverse)
library(colorblindr)
library(ggokabeito)
library(cowplot)
library(gridExtra)
library(here)
here::i_am("Rmd/BCerror_plots.Rmd")
```
More streamlined error plotting for nuclear and mitochondrial encoded tRNAs.
Given tsv files generated by `get_bcerror_freqs.py`, annotate with basecalling error based on a consensus tRNA secondary structure.
```{r}
read_bcerr <- function(x, Sample, ref) {
  df <- readr::read_tsv(x, show_col_types = FALSE)
  
  df <- df %>%
    dplyr::mutate(Sample = Sample)
  
  return(df)
}

# all reads
read_bcerr(here("bcerror/WTyeast004_20231111.tsv"), "WT") -> wt
read_bcerr(here("bcerror/Pus4yeast004_20231208.tsv"), "Pus4del") -> pus4
read_bcerr(here("bcerror/Pus2yeast004_20240105.tsv"), "Pus2del") -> pus2
read_bcerr(here("bcerror/Pus1yeast004_20240105.tsv"), "Pus1del") -> pus1

bind_rows(wt, pus4, pus2, pus1) %>%
  mutate(BCerror = MismatchFreq + InsertionFreq + DeletionFreq) -> all 

rm(wt, pus4, pus2, pus1)

read_tsv(here("ref/structural_alignments/unmodified/sacCer.seq2structure.tsv")) %>%
  rename(Position = seq_pos) %>%
  select(-struct_ref) %>%
  rename(Reference = seq_ref) -> mappings

left_join(all, mappings, by = c("Reference", "Position")) %>%
  select(-N_freq, -Position) %>%
  rename(Position = struct_pos) %>%
  filter(!is.na(Position)) %>% # this removes tRNAs that do not have structural info in the mappings df
  mutate(Position = Position -24) -> mapped # begin counting at the first nt of the tRNA body, not the adapter

# we can then optionally roll up some of this nuclear tRNA data by isodecoder family.
# or even to anticodon leve
mapped %>%
  filter(str_starts(Reference, "mito")) %>%
  select(Reference, Coverage, Sample, BCerror, struct_nt, Position) %>%
  separate(Reference, into = c("Location", "tRNA", "AA", "Anticodon"), sep = "-") %>%
  mutate(Anticodon = str_replace_all(Anticodon, "U", "T")) %>% # because our ref names are inconsistent
  unite(Reference, c("Location", "AA", "Anticodon"), sep = "-") %>%
  select(-tRNA) -> mito_mapped

mapped %>%
  filter(str_starts(Reference, "nuc")) %>%
  select(Reference, Coverage, Sample, BCerror, struct_nt, Position) %>%
  separate(Reference, into = c("Location", "tRNA", "AA", "Anticodon", "Family", "Species"), sep = "-") %>%
  group_by(Location, tRNA, AA, Anticodon, Position, Sample) %>% # roll up to anticodon if not grouped by Family
  summarise(
    TotalCoverage = sum(Coverage),
    WeightedBCerror = sum(pmin(BCerror, 1) * Coverage) / sum(Coverage),  # Revised weighted average calculation
    .groups = "drop"
  ) %>%
  mutate(
    BCerror = ifelse(TotalCoverage > 0, WeightedBCerror, 0)
  ) %>%
  ungroup() %>%
  select(-BCerror) %>%
  rename(Coverage = TotalCoverage, BCerror = WeightedBCerror) %>%
  unite(Reference, c("Location", "AA", "Anticodon"), sep = "-") %>%
  select(-tRNA) -> nuc_mapped

bind_rows(nuc_mapped, mito_mapped) -> test
```
Then take this annotated data and widen it to enforce a coverage threshold and calculate bc error differences.
```{r}
test %>%
  select(Sample, Reference, Position, Coverage, BCerror) %>%
  pivot_wider(
    names_from = Sample,
    names_sep = "_",
    values_from = c(Coverage, BCerror)
  ) %>%
  mutate(
    MinCov = pmin(Coverage_WT, Coverage_Pus4del, Coverage_Pus2del, Coverage_Pus1del, na.rm = TRUE),
    BCerror_WT = replace(BCerror_WT, MinCov < 29, 0),
    BCerror_Pus4del = replace(BCerror_Pus4del, MinCov < 29, 0),
    BCerror_Pus2del = replace(BCerror_Pus2del, MinCov < 29, 0),
    BCerror_Pus1del = replace(BCerror_Pus1del, MinCov < 29, 0),
    Pus4_delta = BCerror_Pus4del - BCerror_WT,
    Pus2_delta = BCerror_Pus2del - BCerror_WT,
    Pus1_delta = BCerror_Pus1del - BCerror_WT
  ) -> diffs

# Reshape the data into a long format
long_data <- diffs %>%
  select(Reference, Position, Pus4_delta, Pus2_delta, Pus1_delta) %>%
  pivot_longer(
    cols = c(Pus4_delta, Pus2_delta, Pus1_delta),
    names_to = "Delta_Type",
    values_to = "Delta_Value"
  )
```
A plotting function for this structurally annotated basecalling error data.
```{r}
plot_basecalling_error <- function(data, delta_type, title_suffix, include_legend = TRUE) {

    # 99 custom x-axis labels for consensus tRNA secondary structure
  x_labels <- c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", 
                "17a", "18", "19", "20", "20a", "20b", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", 
                "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", 
                "e11", "e12", "e13", "e14", "e15", "e16", "e17", "e1", "e2", "e3", "e4", "e5", 
                "e27", "e26", "e25", "e24", "e23", "e22", "e21", "49", "50", "51", "52", "53", "54", "55", "56", "57", 
                "58", "59", "60", "61", "62", "63", "64", "65", "66", "67", "68", "69", "70", "71", "72", "73")


  # Filter the dataset
  filtered_data <- data %>%
    filter(Position >= 1, Position <= 96, Delta_Type == delta_type) %>%
    group_by(Reference) %>%
    filter(any(Delta_Value != 0)) %>%
    ungroup() %>%
    mutate(Reference = fct_rev(as.factor(Reference)))

  # conditional colors for Y axis
  label_colors <- ifelse(grepl("^nuc", levels(filtered_data$Reference)), "black", "#009E73")
  
  # Creating a complete grid of Positions for each Reference
  complete_grid <- expand.grid(Position = 1:96, Reference = unique(filtered_data$Reference))

  # Left join with the filtered dataset
  full_data <- complete_grid %>%
    left_join(filtered_data, by = c("Position", "Reference"))

  # Define a custom function for conditional fill
  conditional_fill <- function(delta_value) {
    ifelse(is.na(delta_value), NA, ifelse(abs(delta_value) < 0.1, NA, delta_value))
  }

  # plot
  p <- ggplot(full_data, aes(x = Position, y = Reference)) +
    # First geom_tile for main data
    geom_tile(aes(fill = Delta_Value), color = "white", size = 0.1) +
    # Second geom_tile for Delta_Value < 0.1
    geom_tile(data = subset(full_data, abs(Delta_Value) < 0.1), aes(x = Position, y = Reference), 
              fill = "white", color = "white", size = 0.1) +
    scale_fill_gradient2(low = "#0072B2", high = "#D55E00", mid = "white", midpoint = 0, 
                         limits = c(-1, 1), na.value = "#D3D3D3") +
    scale_x_continuous(breaks = 1:96, labels = x_labels) +
    theme_cowplot() +
    labs(fill = "âˆ† BC error \n(WT - MT)",
         title = paste("Basecalling error changes", title_suffix),
         x = "",
         y = "")

  # Conditional legend settings
  if (include_legend) {
    p <- p + theme(
      legend.position = "bottom",
#      legend.position = c(0, 1),
#      legend.justification = c(1, 1),
#      legend.box.just = "right",
#      legend.margin = margin(0, 0, 0, 0),
      legend.background = element_rect(fill = "transparent", color = NA),
      legend.box.background = element_rect(fill = "transparent", color = NA),
      legend.key = element_rect(fill = "transparent", color = NA),
      legend.title = element_text(size = 10),
      legend.text = element_text(size = 9)
    ) # Removed the guides modification
  } else {
    p <- p + theme(legend.position = "none")
  }

  
  p <- p + theme(
    axis.text.y = element_text(color = label_colors, angle = 0, hjust = 1, vjust = 0.3, size = 10),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3, size = 10),
  ) +
  coord_fixed(ratio = 1)

  return(p)
}
```
Make plots.
```{r}
plot_basecalling_error(long_data, "Pus1_delta", "on tRNAs upon Pus1 synthase deletion", T) -> p1
plot_basecalling_error(long_data, "Pus2_delta", "on tRNAs upon Pus2 synthase deletion", T) -> p2
plot_basecalling_error(long_data, "Pus4_delta", "on tRNAs upon Pus4 synthase deletion", T) -> p4

p1
p2
p4

```
