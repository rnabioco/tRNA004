---
title: "RNA004_tRNAmods"
author: "Laura White"
date: "2023-11-28"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = F)
library(tidyverse)
library(cowplot)
library(reshape2)
library(here)

here::i_am("rmd/RNA004_tRNAmods.Rmd")
```
Take the output of the diff file produced by the Novoa lab's nanotRNAseq code, which has Modomics mods annotated for each tRNA, and look at how the two chemistries differ in calling bases on the same exact sample. The last column in this file is the composite basecalling error (rate of mismatch, insertion, deletion) for RNA004 - RNA002.

I'm mutating in a new column below to be able to plot bc error from both against each other.
```{r}
readr::read_tsv(here("test.err_diff.tsv")) -> test

# fix dumb col names
test %>%
  dplyr::rename(mods = name, RNA002 = wt, bcdiff = RNA004, tRNA = chrom) %>%
  mutate(RNA004 = (bcdiff + RNA002)) -> test # new chem column = bcdiff + oldchem
```

Now we can look specifically at sites with a given modification and plot the differences in BC error. To do this need to reshape the data.
```{r}
long_mod_df <- test %>%
  filter(!is.na(mods)) %>%
  gather(key = "RNA_type", value = "value", RNA002, RNA004)

# Pre-filter data to remove groups with too few data points
filtered_df <- long_mod_df %>%
  group_by(mods, RNA_type) %>%
  filter(sum(!is.na(value)) > 1) %>%
  ungroup()

# Rename RNA004 to 'new' and RNA002 to 'old' in the RNA_type column
filtered_df <- filtered_df %>%
  mutate(RNA_type = case_when(
    RNA_type == "RNA004" ~ "new",
    RNA_type == "RNA002" ~ "old",
    TRUE ~ RNA_type  # Keeps all other values as is
  ))

# Create the ggplot object
p <- ggplot(filtered_df, aes(x = value, fill = RNA_type)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ mods, scales = "free_y") +  # Free the y-axis scales
  labs(title = "Basecalling error differences at known tRNA modification sites",
       x = "Summed basecalling error",
       y = "Density",
       fill = "Chemistry") +
  scale_fill_manual(values = c("old" = "#000000", "new" = "#56B4E9")) +
  theme_cowplot() 

# Suppress warnings during rendering
suppressWarnings(print(p))


ggsave("bcerr_tRNA_mods.png", plot = last_plot(), width = 10, height = 5)
```


