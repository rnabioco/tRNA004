---
title: "Basecalling error analysis"
author: "Laura White"
date: "2023-12-27"
output: html_document
---
```{r global options, include = FALSE}
knitr::opts_chunk$set(message=FALSE)
library(tidyverse)
library(colorblindr)

library(ggokabeito)
library(cowplot)
library(stringr)
library(here)
here::i_am("Rmd/bcerror.Rmd")
```
Given tsv files generated by `get_bcerror_freqs.py`, examine the overall differences in basecalling error frequencies on different tRNAs between two samples. Let's start with our yeast controls, wild type BY4741 vs. pus4∆, both basecalled with Dorado 0.5.0's _sup_ model for RNA004.
```{r}
read_bcerr <- function(x, Sample, ref) {
  df <- readr::read_tsv(x, show_col_types = FALSE)
  
  df <- df %>%
    dplyr::mutate(Sample = Sample)
  
  return(df)
}

read_bcerr(here("bcerror/WTyeast004_20231111.tsv"), "WT") -> wt
read_bcerr(here("bcerror/Pus4yeast004_20231208.tsv"), "Pus4del") -> pus4
read_bcerr(here("bcerror/Pus2yeast004_20240105.tsv"), "Pus2del") -> pus2
read_bcerr(here("bcerror/Pus1yeast004_20240105.tsv"), "Pus1del") -> pus1

bind_rows(wt, pus4, pus2, pus1) %>%
  mutate(Position = (Position - 24)) %>%
  mutate(BCerror = MismatchFreq + InsertionFreq + DeletionFreq) -> all # begin counting at the first NT of the tRNA.

rm(wt, pus4, pus2, pus1)

```

Widen the data to enforce a coverage threshold and calculate bc error differences.
```{r}
all %>%
  select(Sample, Reference, Position, Coverage, BCerror) %>%
  pivot_wider(
    names_from = Sample,
    names_sep = "_",
    values_from = c(Coverage, BCerror)
  ) %>%
  mutate(
    MinCov = pmin(Coverage_WT, Coverage_Pus4del, Coverage_Pus2del, Coverage_Pus1del, na.rm = TRUE),
    BCerror_WT = replace(BCerror_WT, MinCov < 29, 0),
    BCerror_Pus4del = replace(BCerror_Pus4del, MinCov < 29, 0),
    BCerror_Pus2del = replace(BCerror_Pus2del, MinCov < 29, 0),
    BCerror_Pus1del = replace(BCerror_Pus1del, MinCov < 29, 0),
    Pus4_delta = BCerror_Pus4del - BCerror_WT,
    Pus2_delta = BCerror_Pus2del - BCerror_WT,
    Pus1_delta = BCerror_Pus1del - BCerror_WT
  ) -> diffs
  
```

Exploratory heatmap plotting. NOT aligned to structure.
```{r}
# Reshape the data into a long format
long_data <- diffs %>%
  select(Reference, Position, Pus4_delta, Pus2_delta, Pus1_delta) %>%
  pivot_longer(
    cols = c(Pus4_delta, Pus2_delta, Pus1_delta),
    names_to = "Delta_Type",
    values_to = "Delta_Value"
  )

# Create a combined identifier, but shorter
long_data_combined <- long_data %>%
  filter(str_starts(Reference, "mito")) %>%
  mutate(Reference = str_replace(Reference, "mito-tRNA-", "")) %>%
  mutate(Ref_Delta = paste(Reference, Delta_Type, sep = "_"))

# Creating the heatmap
ggplot(long_data_combined, aes(x = Position, y = Ref_Delta, fill = Delta_Value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
  scale_x_continuous(breaks = seq(-20, max(long_data_combined$Position, na.rm = TRUE), by = 10)) +
  theme_minimal() +
  labs(fill = "∆ basecalling error \n(WT - MT)",
       title = "Basecalling error changes on mt-tRNAs upon pseudouridine synthase deletion",
       x = "Position",
       y = "Reference and Delta Type") +
  theme(axis.text.y = element_text(angle = 0, hjust = 1, vjust = 0.5))

```
If we want to group the different deletions instead:
```{r}
ggplot(long_data_combined, aes(x = Position, y = Reference, fill = Delta_Value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
  scale_x_continuous(breaks = seq(-20, max(long_data_combined$Position, na.rm = TRUE), by = 10)) +
  theme_minimal() +
  labs(fill = "∆ basecalling error \n(WT - MT)",
       title = "Basecalling error changes on mt-tRNAs upon pseudouridine synthase deletion",
       x = "Position",
       y = "Reference and Delta Type") +
  theme(axis.text.y = element_text(angle = 0, hjust = 1, vjust = 0.5)) +
  facet_wrap(~ Delta_Type)
```
If we instead look at nuclear tRNAs
```{r}
# Create a combined identifier, but shorter
long_data_combined <- long_data %>%
  filter(str_starts(Reference, "nuc")) %>%
  mutate(Reference = str_replace(Reference, "nuc-tRNA-", "")) %>%
  mutate(Ref_Delta = paste(Reference, Delta_Type, sep = "_"))

# Creating the heatmap
ggplot(long_data_combined, aes(x = Position, y = Reference, fill = Delta_Value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
  theme_minimal() +
  labs(fill = "∆ basecalling error \n(WT - MT)",
       title = "Basecalling error changes on nuclear tRNAs upon pseudouridine synthase deletion",
       x = "Position",
       y = "Reference and Delta Type") +
  theme(axis.text.y = element_text(angle = 0, hjust = 1, vjust = 0.5)) +
  facet_wrap(~ Delta_Type)

```

Now, can we pull in our tsv containing sequence to structure mappings and use that to make nicer plots.
```{r}
read_tsv(here("ref/structural_alignments/unmodified/sacCer.seq2structure.tsv")) %>%
  filter(str_starts(seq_ref, "mito"))  %>% 
  mutate(struct_pos = (struct_pos - 24)) %>%
  mutate(Position = (seq_pos - 24)) %>%
  rename(Reference = seq_ref)-> mito_mappings

long_data %>%
  filter(str_starts(Reference, "mito")) -> mito_long_data

left_join(mito_long_data, mito_mappings, by = c("Reference", "Position")) %>%
  select(-seq_pos) %>%
  mutate(Reference = str_replace(Reference, "mito-tRNA-", "")) %>%
  mutate(Ref_Delta = paste(Reference, Delta_Type, sep = "_")) -> test 
```
make new structure anchored heat map
```{r}
test %>%
  filter(!is.na(struct_pos)) %>%
  filter(struct_pos >= 1, struct_pos <= 99) %>%  # Filter to keep only positions 1 to 99
  filter(Delta_Type == "Pus4_delta") %>%
  group_by(Reference) %>%
  filter(any(Delta_Value != 0)) %>%
  ungroup() %>%
  mutate(Reference = fct_rev(as.factor(Reference))) %>%
  ggplot(., aes(x = struct_pos, y = Reference, fill = Delta_Value)) +
    geom_tile() +
    scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
    scale_x_continuous(breaks = seq(0, 100, by = 10)) +
    theme_cowplot() +
    labs(fill = "∆ basecalling error \n(WT - MT)",
         title = "Basecalling error changes on mt-tRNAs upon Pus4 synthase deletion",
         x = "Position",
         y = "tRNA reference") +
    theme(axis.text.y = element_text(angle = 0, hjust = 1, vjust = 0.5, size = 12)) +
    coord_fixed(ratio = 1)
```

```{r}
library(forcats)

# Filter the dataset
filtered_test <- test %>%
  filter(!is.na(struct_pos), struct_pos >= 1, struct_pos <= 99, Delta_Type == "Pus1_delta") %>%
  group_by(Reference) %>%
  filter(any(Delta_Value != 0)) %>%
  ungroup() %>%
  mutate(Reference = fct_rev(as.factor(Reference)))

# Creating a complete grid of struct_pos for each Reference
complete_grid <- expand.grid(struct_pos = 1:99, Reference = unique(filtered_test$Reference))

# Left join with the filtered dataset
full_data <- complete_grid %>%
  left_join(filtered_test, by = c("struct_pos", "Reference"))

# plot
ggplot(full_data, aes(x = struct_pos, y = Reference, fill = Delta_Value)) +
  geom_tile(color = "white", size = 0.1) +
  scale_fill_gradient2(low = "#0072B2", high = "#D55E00", mid = "white", midpoint = 0, 
                       limits = c(-1, 1), na.value = "#D3D3D3") +
  scale_x_continuous(breaks = 1:99, labels = rep("", 99)) +
  theme_cowplot() +
  labs(fill = "∆ basecalling error \n(WT - MT)",
       title = "Basecalling error changes on mt-tRNAs upon Pus1 synthase deletion",
       x = "",
       y = "") +
  theme(
    axis.text.y = element_text(angle = 0, hjust = 1, vjust = 0.3, size = 10),
    legend.position = "bottom",
    legend.box = "horizontal",
    legend.title.align = 0.5,
    legend.text = element_text(size = 9),
    legend.title = element_text(size = 10)
  ) +
  coord_fixed(ratio = 1)



```



