---
title: "Basecalling error analysis"
author: "Laura White"
date: "2023-12-27"
output: html_document
---
```{r global options, include = FALSE}
knitr::opts_chunk$set(message=FALSE)
library(tidyverse)
library(colorblindr)

library(ggokabeito)
library(cowplot)
library(here)
here::i_am("Rmd/bcerror.Rmd")
```
Given tsv files generated by `get_bcerror_freqs.py`, examine the overall differences in basecalling error frequencies on different tRNAs between two samples. Let's start with our yeast controls, wild type BY4741 vs. pus4âˆ†, both basecalled with Dorado 0.5.0's _sup_ model for RNA004.
```{r}
read_bcerr <- function(x, sample, ref) {
  df <- readr::read_tsv(x, show_col_types = FALSE)
  
  df <- df %>%
    dplyr::mutate(sample = sample)
  
  return(df)
}

read_bcerr(here("bcerror/WTyeast004_20231111.bcerror.tsv"), "WT") -> wt
read_bcerr(here("bcerror/Pus4yeast004_20231208.bcerror.tsv"), "Pus4del") -> pus4

bind_rows(wt, pus4) %>%
  mutate(Position = (Position - 24)) -> all # begin counting at the first NT of the tRNA.

rm(wt, pus4)
```
We can plot these two samples for different tRNAs. But to enforce a minimum coverage threshold for plotting, we need to widen the data.
```{r}
all %>%
  filter(grepl("^tRNA-Trp-CCA-1-1", Reference)) %>% # look at specific tRNA
  select(sample, Reference, Position, Coverage, MismatchFreq, InsertionFreq, DeletionFreq, MeanQual) %>%
  pivot_wider(names_from = sample, values_from = c(Coverage, MismatchFreq, InsertionFreq, DeletionFreq, MeanQual)) %>%
  mutate(mincov = pmin(Coverage_WT, Coverage_Pus4del)) %>% # one column containing the lower of the two coverage values
  mutate(MismatchFreq_WT = replace(MismatchFreq_WT, mincov < 29, 0)) %>% # put zeros in for any position where either sample lacks min coverage
  mutate(InsertionFreq_WT = replace(InsertionFreq_WT, mincov < 29, 0)) %>%
  mutate(DeletionFreq_WT = replace(DeletionFreq_WT, mincov < 29, 0)) %>%
  mutate(MismatchFreq_Pus4del = replace(MismatchFreq_Pus4del, mincov < 29, 0)) %>%
  mutate(InsertionFreq_Pus4del = replace(InsertionFreq_Pus4del, mincov < 29, 0)) %>% #
  mutate(DeletionFreq_Pus4del = replace(DeletionFreq_Pus4del, mincov < 29, 0)) -> test
```
Test plotting. 
```{r}
test %>%
  gather(key = "sample", value = "mismatch_rate", MismatchFreq_WT, MismatchFreq_Pus4del) %>%
  arrange(sample, Position) %>%
  ggplot(., aes(x = Position, y = mismatch_rate)) +
  geom_line(aes(color = sample)) +
#  geom_point(aes(color = sample)) +
  labs(x = "Position", y = "Mismatch rate", title = "") +
  theme_cowplot() +
  scale_color_okabe_ito() +
  scale_x_continuous(breaks = seq(-20, 130, by = 5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = .5)) +
  theme(aspect.ratio = 1/5) 
```


