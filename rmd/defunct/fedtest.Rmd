---
title: "Phage BCerror"
author: "Laura White"
date: "2024-02-19"
output: html_document
---
```{r global options, include = FALSE}
knitr::opts_chunk$set(message=FALSE)
library(tidyverse)
library(colorblindr)
library(ggokabeito)
library(cowplot)
library(gridExtra)
library(here)
here::i_am("Rmd/fedtest.Rmd")
```
More streamlined error plotting for nuclear and mitochondrial encoded tRNAs.
Given tsv files generated by `get_bcerror_freqs.py`, annotate with basecalling error based on a consensus tRNA secondary structure.
```{r}
read_bcerr <- function(x, Sample, ref) {
  df <- readr::read_tsv(x, show_col_types = FALSE)
  
  df <- df %>%
    dplyr::mutate(Sample = Sample)
  
  return(df)
}

# all reads
read_bcerr(here("bcerror/C0_R1_fedtest.tsv"), "t0") %>%
  mutate(BCerror = MismatchFreq + InsertionFreq + DeletionFreq) -> fedt0

```

read_bcerr(here("bcerror/T4_uninfected_ecoli.bcerror.tsv"), "uninfected") %>%
  mutate(BCerror = MismatchFreq + InsertionFreq + DeletionFreq) -> ecoli

bind_rows(t4ecoli, ecoli) -> all

read_tsv(here("ref/structural_alignments/unmodified/T4infectedecoli.seq2structure.tsv")) %>%
  rename(Position = seq_pos) %>%
  select(-struct_ref) %>%
  rename(Reference = seq_ref) -> mappings

left_join(all, mappings, by = c("Reference", "Position")) %>%
  select(-N_freq, -Position) %>%
  rename(Position = struct_pos) %>%
  filter(!is.na(Position)) %>% # this removes tRNAs that do not have structural info in the mappings df
  mutate(Position = Position -24) -> mapped # begin counting at the first nt of the tRNA body, not the adapter

# we can then optionally roll up some of this nuclear tRNA data by isodecoder family
# since there are no duplicate isodecoders in the phage reference these are easy
mapped %>%
  filter(str_starts(Reference, "phage")) %>%
  select(Reference, Spanning_Reads, Sample, BCerror, struct_nt, Position) %>%
  separate(Reference, into = c("Origin", "tRNA", "AA", "Anticodon"), sep = "-") %>%
  unite(Reference, c("Origin", "AA", "Anticodon"), sep = "-") %>%
  rename(Coverage = Spanning_Reads) %>%
  select(-tRNA, -struct_nt) -> phage_mapped

mapped %>%
  filter(str_starts(Reference, "host")) %>%
  select(Reference, Spanning_Reads, Sample, BCerror, struct_nt, Position) %>%
  separate(Reference, into = c("Origin", "tRNA", "AA", "Anticodon", "Family", "Species"), sep = "-") %>%
  group_by(Origin, tRNA, AA, Anticodon, Position, Sample) %>% # roll up to anticodon if not grouped by Family
  summarise(
    TotalCoverage = sum(Spanning_Reads),
    WeightedBCerror = sum(pmin(BCerror, 1) * Spanning_Reads) / sum(Spanning_Reads),  # Revised weighted average calculation
    .groups = "drop"
  ) %>%
  mutate(
    BCerror = ifelse(TotalCoverage > 0, WeightedBCerror, 0)
  ) %>%
  ungroup() %>%
  select(-BCerror) %>%
  rename(Coverage = TotalCoverage, BCerror = WeightedBCerror) %>%
  unite(Reference, c("Origin", "AA", "Anticodon"), sep = "-") %>%
  select(-tRNA) -> host_mapped

bind_rows(host_mapped, phage_mapped) -> test
