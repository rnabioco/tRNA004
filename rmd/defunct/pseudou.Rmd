---
title: "Pseudouridine signals"
author: "Laura White"
date: "2024-06-25"
output: html_document
---
---
```{r global options, include = FALSE}
knitr::opts_chunk$set(message=FALSE)
library(tidyverse)
library(colorblindr)
library(ggokabeito)
library(cowplot)
library(ggrepel)
library(patchwork)
library(ggtext)
library(here)
here::i_am("Rmd/pseudou.Rmd")
```

We can take our tRNA basecalling error data and ask questions about how well we can detect different RNA modifications in multiple sequence contexts across multiple organisms. This is enabled by (a) abundant LC/MS data about tRNA modifications from Modomics and (b) our ability to pin our basecalling error data onto structure files and line them up with modification info.

Here's a function to read in the mappings from modified and unmodified tRNA aligned to a consensus sequence, for joining to sequence alignments.
```{r}
process_files <- function(prefix) {
  # Construct file paths
  mod_file_path <- here("ref/structural_alignments/modified", paste0(prefix, ".mods.seq2structure.tsv"))
  nomod_file_path <- here("ref/structural_alignments/unmodified", paste0(prefix, ".seq2structure.tsv"))

  # Read and process the modified file
  mod_map <- read_tsv(mod_file_path) %>%
    rename(Position = seq_pos, mod_nt = struct_nt) %>%
    select(-struct_ref) %>%
    rename(Reference = seq_ref) %>%
    distinct(Reference, Position, .keep_all = TRUE)

  # Read and process the unmodified file
  nomod_map <- read_tsv(nomod_file_path) %>%
    rename(Position = seq_pos) %>%
    select(-struct_ref) %>%
    rename(Reference = seq_ref) %>%
    distinct(Reference, Position, .keep_all = TRUE)

  # Join the datasets
  joined_map <- left_join(mod_map, nomod_map, by = c("Reference", "Position", "struct_pos"))

  # Add the 'species' column
  joined_map <- mutate(joined_map, species = prefix)

  # Assign the joined dataset to the global environment
  joined_map_name <- paste0(prefix, "_mappings")
  assign(joined_map_name, joined_map, envir = .GlobalEnv)
}
```

Below, bring in the mapping information.
```{r}
process_files("scerevisiae")
process_files("hsapiens")
process_files("tthermophila")
process_files("ecoli")
process_files("dmelanogaster")
bind_rows(scerevisiae_mappings, hsapiens_mappings, tthermophila_mappings, ecoli_mappings, dmelanogaster_mappings) -> mappings
rm(scerevisiae_mappings, hsapiens_mappings, tthermophila_mappings, ecoli_mappings, dmelanogaster_mappings)
```

Then bring in tsvs that contain the error frequencies for each sample for highest accuracy 002 vs 004.
```{r}
read_bcerr <- function(x, species, ref) {
  df <- readr::read_tsv(x, show_col_types = FALSE)
  
  df <- df %>%
    dplyr::mutate(species = species)
  
  return(df)
}

# function to get 5mer sequence context for each mod
create_rolling_string <- function(nt_vec) {
  sapply(seq_along(nt_vec), function(i) {
    if (i < 3 | i > length(nt_vec) - 2) {
      return(NA)
    }
    
    rolling_elems <- c(lag(nt_vec, 2)[i], lag(nt_vec, 1)[i], nt_vec[i], lead(nt_vec, 1)[i], lead(nt_vec, 2)[i])
    
    if (any(is.na(rolling_elems))) {
      return(NA)
    } else {
      return(paste0(rolling_elems, collapse = ""))
    }
  })
}

#004 data
read_bcerr(here("bcerror/RNA004v5/yeast/WTyeast004_20231111_1104_P2S-00519-B_PAQ47538_fa3726ec.rna004_130bps_sup@v5.0.0.tsv"), "scerevisiae") -> scerevisiae
read_bcerr(here("bcerror/RNA004v5/HumanFibroblast004_20231208_1351_MN42516_FAX71838_b8f7b990.rna004_130bps_sup@v5.0.0.tsv"), "hsapiens") -> hsapiens
read_bcerr(here("bcerror/RNA004v5/Drosophila004_20231208_1307_MN31004_FAX73799_72c200e4.rna004_130bps_sup@v5.0.0.tsv"), "dmelanogaster") -> dmelanogaster
read_bcerr(here("bcerror/RNA004v5/Ecoli004_20240105_1224_MN31004_FAX73799_1fe84761.rna004_130bps_sup@v5.0.0.tsv"), "ecoli") -> ecoli
read_bcerr(here("bcerror/RNA004v5/Tetrahymena004_20231208_0920_MN42516_FAX71838_a244513d.rna004_130bps_sup@v5.0.0.tsv"), "tthermophila") -> tthermophila

# we need to add 1 to His tRNAs only, because the structured fastas have the 5' G & the seqref doesn't.
bind_rows(hsapiens, dmelanogaster, ecoli, tthermophila, scerevisiae) %>%
  mutate(Position = ifelse(grepl("His", Reference), Position + 1, Position)) -> allspecies

rm(scerevisiae, hsapiens, dmelanogaster, ecoli, tthermophila)

left_join(allspecies, mappings, by = c("Reference", "Position", "species")) %>%
  select(-N_freq) %>%
  rename(seq_pos = Position) %>%
  rename(Position = struct_pos) %>%
  filter(!is.na(Position))  %>% # this removes tRNAs that do not have structural info in the mappings df
  mutate(Position = Position - 24) %>%
  group_by(species, Reference) %>%
  arrange(Position) %>%
  mutate(kmer_context = create_rolling_string(struct_nt)) %>%
  mutate(mod_context = create_rolling_string(mod_nt)) %>%
#  filter(!is.na(kmer_context) & !mod_nt %in% c('A', 'C', 'G', 'T', 'U')) %>% # only keep positions with modifications 
  filter(Bases_Mapped >29) %>%
  mutate(chemistry = "004") -> mapped4


#004v3 data
read_bcerr(here("bcerror/RNA004v3/WTyeast004_20231111_1104_P2S-00519-B_PAQ47538_fa3726ec.rna004_130bps_sup@v3.0.1.tsv"), "scerevisiae") -> scerevisiae
read_bcerr(here("bcerror/RNA004v3/HumanFibroblast004_20231208_1351_MN42516_FAX71838_b8f7b990.rna004_130bps_sup@v3.0.1.tsv"), "hsapiens") -> hsapiens
read_bcerr(here("bcerror/RNA004v3/Drosophila004_20231208_1307_MN31004_FAX73799_72c200e4.rna004_130bps_sup@v3.0.1.tsv"), "dmelanogaster") -> dmelanogaster
read_bcerr(here("bcerror/RNA004v3/Ecoli004_20240105_1224_MN31004_FAX73799_1fe84761.rna004_130bps_sup@v3.0.1.tsv"), "ecoli") -> ecoli
read_bcerr(here("bcerror/RNA004v3/Tetrahymena004_20231208_0920_MN42516_FAX71838_a244513d.rna004_130bps_sup@v3.0.1.tsv"), "tthermophila") -> tthermophila

# we need to add 1 to His tRNAs only, because the structured fastas have the 5' G & the seqref doesn't.
bind_rows(hsapiens, dmelanogaster, ecoli, tthermophila, scerevisiae) %>%
  mutate(Position = ifelse(grepl("His", Reference), Position + 1, Position)) -> allspecies

rm(scerevisiae, hsapiens, dmelanogaster, ecoli, tthermophila)

left_join(allspecies, mappings, by = c("Reference", "Position", "species")) %>%
  select(-N_freq) %>%
  rename(seq_pos = Position) %>%
  rename(Position = struct_pos) %>%
  filter(!is.na(Position))  %>% # this removes tRNAs that do not have structural info in the mappings df
  mutate(Position = Position - 24) %>%
  group_by(species, Reference) %>%
  arrange(Position) %>%
  mutate(kmer_context = create_rolling_string(struct_nt)) %>%
  mutate(mod_context = create_rolling_string(mod_nt)) %>%
#  filter(!is.na(kmer_context) & !mod_nt %in% c('A', 'C', 'G', 'T', 'U')) %>% # only keep positions with modifications 
  filter(Bases_Mapped >29) %>%
  mutate(chemistry = "003") -> mapped3

#002 data
read_bcerr(here("bcerror/RNA002/WTyeast002_20231111_1103_P2S-00519-A_PAS43478_1fa49e43.rna002_70bps_hac@v3.tsv"), "scerevisiae") -> scerevisiae
read_bcerr(here("bcerror/RNA002/HumanFibroblast002_20231207_1455_P2S-00519-B_PAS29437_b7f6c4bd.rna002_70bps_hac@v3.tsv"), "hsapiens") -> hsapiens
read_bcerr(here("bcerror/RNA002/Drosophila002_20231207_1500_MN35252_FAX30455_48242de2.rna002_70bps_hac@v3.tsv"), "dmelanogaster") -> dmelanogaster
read_bcerr(here("bcerror/RNA002/Ecoli002_20231208_1312_P2S-00519-A_PAS44628_9e5214a7.rna002_70bps_hac@v3.tsv"), "ecoli") -> ecoli
read_bcerr(here("bcerror/RNA002/Tetrahymena002_20231207_1743_MN35252_FAX30455_c9f80979.rna002_70bps_hac@v3.tsv"), "tthermophila") -> tthermophila

# we need to add 1 to His tRNAs only, because the structured fastas have the 5' G & the seqref doesn't.
bind_rows(hsapiens, dmelanogaster, ecoli, tthermophila, scerevisiae) %>%
  mutate(Position = ifelse(grepl("His", Reference), Position + 1, Position)) -> allspecies

rm(scerevisiae, hsapiens, dmelanogaster, ecoli, tthermophila)

left_join(allspecies, mappings, by = c("Reference", "Position", "species")) %>%
  select(-N_freq) %>%
  rename(seq_pos = Position) %>%
  rename(Position = struct_pos) %>%
  filter(!is.na(Position))  %>% # this removes tRNAs that do not have structural info in the mappings df
  mutate(Position = Position - 24) %>%
  group_by(species, Reference) %>%
  arrange(Position) %>%
  mutate(kmer_context = create_rolling_string(struct_nt)) %>%
  mutate(mod_context = create_rolling_string(mod_nt)) %>%
#  filter(!is.na(kmer_context) & !mod_nt %in% c('A', 'C', 'G', 'T', 'U')) %>% # only keep positions with modifications 
  filter(Bases_Mapped >29) %>%
  mutate(chemistry = "002") -> mapped2

bind_rows(mapped2, mapped4, mapped3) -> mapped
rm(allspecies, mapped2, mapped4, mapped3)
```

Alright, now we have all the data in one large df.
We also pull in the database of Modomics codes in order to convert single character codes to short names.
```{r}
modomics <- read_csv(here("Modomics/modomicscodes.csv")) %>%
  select(Name, `Short Name`, `RNAMods code (2023)`) %>%
  rename(modname = Name, shortname = `Short Name`, mod_nt = `RNAMods code (2023)`) %>%
  group_by(mod_nt) %>%
  arrange(mod_nt, shortname) %>%
  # filter 5'-monophosphate containing duplicate shortnames
  filter(!(startsWith(shortname, "p") & (mod_nt %in% lag(mod_nt) | mod_nt %in% lead(mod_nt))))

# Replace backslash with "Ħ" in the mapped dataset (old Modomics code usage)
mapped$mod_nt <- ifelse(mapped$mod_nt == "\\", "Ħ", mapped$mod_nt)

left_join(mapped, modomics) -> mapped
```

And now let's filter for pseudouridines only.
```{r}
mapped %>%
  filter(shortname == "Y") %>%
  select(Reference, Position, MismatchFreq, InsertionFreq, DeletionFreq, BCErrorFreq, MeanQual, species, mod_nt, struct_nt, mod_context, chemistry) -> pseudou
```
Compare pseudou signals between thew two chemistries.
```{r}
pseudou <- pseudou %>%
  mutate(chemistry = factor(chemistry))

# Ensure each Reference, species, Position combination has both chemistries
filtered_data <- pseudou %>%
  group_by(Reference, species, Position) %>%
  filter(n_distinct(chemistry) == 2) %>%
  ungroup()

# Plot the data
plot_modification_data <- function(data) {
  p <- ggplot(data, aes(x = chemistry, y = BCErrorFreq, fill = chemistry)) +
    geom_violin() +
    theme_minimal() +
    theme(
      axis.text.y = element_text(size = 8),
      axis.text.x = element_text(size = 10),
      strip.text = element_text(size = 10),
      legend.position = "bottom"
    ) +
    labs(title = "BCErrorFreq Distributions for 002 vs 004 Chemistry",
         x = "Chemistry",
         y = "BCErrorFreq",
         fill = "")

  return(p)
}

# Create the plot
plot <- plot_modification_data(filtered_data)
print(plot)
```
Note that I'm being lazy and calling this "003" when I mean v3 SUP calling of RNA004. I just didn't want to create another column to categorize this data on.
What about looking at correlations by mod context? We have 40 distinct ones that appear in both chemistries at the same sites.
```{r}
# Function to count non-AGCU characters in mod_context strings
count_non_agcu_chars <- function(mod_context) {
  # Define the allowed characters
  allowed_chars <- c("A", "G", "C", "U")
  
  # Extract the surrounding characters
  surrounding_chars <- c(substr(mod_context, 1, 1), substr(mod_context, 2, 2), substr(mod_context, 4, 4), substr(mod_context, 5, 5))
  
  # Count the number of non-AGCU characters
  non_agcu_count <- sum(!surrounding_chars %in% allowed_chars)
  
  return(non_agcu_count)
}


# Ensure chemistry is a factor
pseudou <- pseudou %>%
  mutate(chemistry = factor(chemistry))

# Filter to ensure each mod_context has both 002 and 004 (v3 & v5) data
filtered_data <- pseudou %>%
  group_by(mod_context) %>%
  filter(n_distinct(chemistry) == 3) %>%
  ungroup()

# Calculate the mean BCErrorFreq for each mod_context and chemistry
aggregated_data <- filtered_data %>%
  group_by(mod_context, chemistry) %>%
  summarise(mean_BCErrorFreq = mean(BCErrorFreq, na.rm = TRUE)) %>%
  ungroup()

# Reshape the data from long to wide format
wide_data <- aggregated_data %>%
  pivot_wider(names_from = chemistry, values_from = mean_BCErrorFreq, names_prefix = "mean_BCErrorFreq_")

# Add the non-AGCU count column
wide_data <- wide_data %>%
  mutate(non_agcu_count = sapply(mod_context, count_non_agcu_chars))

# Add the non-AGCU count column
wide_data <- wide_data %>%
  mutate(non_agcu_count = sapply(mod_context, count_non_agcu_chars))

# Calculate the axis limits
axis_limits <- range(c(wide_data$mean_BCErrorFreq_002, wide_data$mean_BCErrorFreq_004), na.rm = TRUE)

# Calculate Pearson correlation coefficient
correlation_coefficient <- cor(wide_data$mean_BCErrorFreq_002, wide_data$mean_BCErrorFreq_004, use = "complete.obs")

# Plot the correlation with the same axis limits for X and Y and square plot area
plot_correlation <- function(data, corr_coeff) {
  ggplot(data, aes(x = mean_BCErrorFreq_002, y = mean_BCErrorFreq_004, color = as.factor(non_agcu_count))) +
    geom_text_repel(aes(label = mod_context), size = 3, max.overlaps = Inf) +  # Increase max.overlaps to Inf
    theme_cowplot() +
    labs(title = "",
         x = "Mean BCError, RNA002",
         y = "Mean BCError, RNA004",
         color = "Additional modifications in 5mer") +
    xlim(axis_limits) +
    ylim(axis_limits) +
    coord_fixed(ratio = 1) +  # Ensure the plot area is square
    annotate("text", x = min(axis_limits), y = max(axis_limits), 
             label = paste("Pearson's ρ:", round(corr_coeff, 2)), 
             hjust = 0, vjust = 1, size = 5) +
    theme(axis.text = element_text(size = 12)) + # Increase axis tick label size
    scale_color_OkabeIto(order = c(8,2,6))
}


# Create the plot
correlation_plot <- plot_correlation(wide_data, correlation_coefficient)
print(correlation_plot)

# v3 vs v5 calling
# Calculate the axis limits
axis_limits <- range(c(wide_data$mean_BCErrorFreq_003, wide_data$mean_BCErrorFreq_004), na.rm = TRUE)

# Calculate Pearson correlation coefficient
correlation_coefficient <- cor(wide_data$mean_BCErrorFreq_003, wide_data$mean_BCErrorFreq_004, use = "complete.obs")

# Plot the correlation with the same axis limits for X and Y and square plot area
plot_correlation <- function(data, corr_coeff) {
  ggplot(data, aes(x = mean_BCErrorFreq_003, y = mean_BCErrorFreq_004, color = as.factor(non_agcu_count))) +
    geom_text_repel(aes(label = mod_context), size = 3, max.overlaps = Inf) +  # Increase max.overlaps to Inf
    theme_cowplot() +
    labs(title = "",
         x = "Mean BCError, RNA004 SUP@v3",
         y = "Mean BCError, RNA004 SUP@v5",
         color = "Additional modifications in 5mer") +
    xlim(axis_limits) +
    ylim(axis_limits) +
    coord_fixed(ratio = 1) +  # Ensure the plot area is square
    annotate("text", x = min(axis_limits), y = max(axis_limits), 
             label = paste("Pearson's ρ:", round(corr_coeff, 2)), 
             hjust = 0, vjust = 1, size = 5) +
    theme(axis.text = element_text(size = 12)) + # Increase axis tick label size
    scale_color_OkabeIto(order = c(8,2,6))
}

# Create the plot
correlation_plot <- plot_correlation(wide_data, correlation_coefficient)
print(correlation_plot)
```



