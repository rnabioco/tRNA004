---
title: "modomics"
author: "Laura White"
date: "2023-11-29"
output: html_document
---
```{r}
knitr::opts_chunk$set(echo = F)
library(tidyverse)
library(cowplot)
library(stringr)
library(here)

here::i_am("rmd/modomics.Rmd")
```

Here's function to read in fasta files of tRNA sequences from Modomics database (http://modomics.genesilico.pl/) and parse their headers so that we can make a clean table of tRNA sequences with modifications and their metadata.
```{r}
# to parse a single FASTA file with headers from Modomics.org
parse_fasta <- function(file_path) {
    fasta_lines <- read_lines(file_path)

    # Split lines into headers and sequences
    headers <- fasta_lines[str_detect(fasta_lines, "^>")]
    sequences <- fasta_lines[!str_detect(fasta_lines, "^>")]

    # Function to parse headers
    parse_header <- function(header) {
        key_value_pairs <- str_split(str_remove_all(header, "^>"), "\\|", simplify = FALSE)[[1]]
        key_value_pairs <- lapply(key_value_pairs, function(x) str_split(x, ":", simplify = TRUE)[1, 2])
        return(as.data.frame(t(key_value_pairs), stringsAsFactors = FALSE))
    }

    # Parse all headers
    parsed_headers <- do.call(rbind, lapply(headers, parse_header))

    # Assign column names
    colnames(parsed_headers) <- c("ID", "Name", "SOterm", "Type", "AA", "Anticodon", "Cellular_Localization", "Species")

    # Combine headers and sequences
    final_data <- data.frame(parsed_headers, Sequence = sequences)

    # Tidy up the data
    final_data <- final_data %>%
        mutate(across(everything(), ~str_trim(.))) %>% 
        mutate(across(where(is.character), ~str_remove_all(., pattern = "^[^:]+:"))) %>%
        select(-ID, -SOterm, -Type)

    return(final_data)
}
```
Use this function to read in the files from Modomics for the 3 species of interest
```{r}
parse_fasta(here("Modomics/unmodified_ecoli_trna_sequences.fasta")) -> ecoli_unmodified
parse_fasta(here("Modomics/unmodified_scerevisiae_trna_sequences.fasta")) -> yeast_unmodified
parse_fasta(here("Modomics/unmodified_hsapiens_trna_sequences.fasta")) -> human_unmodified

parse_fasta(here("Modomics/modified_ecoli_trna_sequences.fasta")) -> ecoli_modified
parse_fasta(here("Modomics/modified_scerevisiae_trna_sequences.fasta")) -> yeast_modified
parse_fasta(here("Modomics/modified_hsapiens_trna_sequences.fasta")) -> human_modified
```

Then the next thing we want to do is get from these to a bed file like `https://github.com/novoalab/Nano-tRNAseq/blob/c14dcaaf4e59164d5dc43716019b8d39f2d554da/ref/yeast.tRNA.modomics.tsv.bed#L4`
After we do this, we'll need to do is convert the unicode symbols into the Modomics short names to make the modifications more human-readable.

```{r}
generate_bed_data <- function(df) {
  bed_data_list <- lapply(1:nrow(df), function(i) {
    seq_name <- df$Name[i]
    aa <- df$AA[i]
    anticodon <- df$Anticodon[i]
    cellular_location <- df$Cellular_Localization[i]
    species <- df$Species[i]
    sequence <- df$Sequence[i]
    special_chars <- str_locate_all(sequence, "[^A-Za-z]")[[1]]  # Adjust regex for your needs
    if (is.null(special_chars) || nrow(special_chars) == 0) {
      return(NULL)  # No special characters found
    }
    special_chars_df <- as.data.frame(special_chars)
    special_chars_df$Name <- seq_name
    special_chars_df$AA <- aa
    special_chars_df$Anticodon <- anticodon
    special_chars_df$Cellular_Localization <- cellular_location
    special_chars_df$Species <- species
    special_chars_df$ASCII_mod <- str_sub(sequence, special_chars_df$start, special_chars_df$end)
    colnames(special_chars_df) <- c("Start", "End", "Name", "AA", "Anticodon", "Cellular_Localization", "Species", "ASCII_mod")
    return(special_chars_df)
  })
  do.call("rbind", bed_data_list)
}

bed_data <- generate_bed_data(yeast_modified)

# test write to bed file
output_file_path <- here("ref", "yeast_tRNA_modifications.bed")
write.table(bed_data, output_file_path, sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

