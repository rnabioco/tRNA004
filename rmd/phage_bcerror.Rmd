---
title: "Phage BCerror"
author: "Laura White"
date: "2024-02-19"
output: html_document
---
```{r global options, include = FALSE}
knitr::opts_chunk$set(message=FALSE)
library(tidyverse)
library(colorblindr)
library(ggokabeito)
library(cowplot)
library(gridExtra)
library(here)
here::i_am("Rmd/phage_bcerror.Rmd")
```
More streamlined error plotting for nuclear and mitochondrial encoded tRNAs.
Given tsv files generated by `get_bcerror_freqs.py`, annotate with basecalling error based on a consensus tRNA secondary structure.
Given tsv files generated by `get_bcerror_freqs.py`, annotate with basecalling error based on a consensus tRNA secondary structure.
```{r}
read_bcerr <- function(x, Sample, ref) {
  df <- readr::read_tsv(x, show_col_types = FALSE)
  
  df <- df %>%
    dplyr::mutate(Sample = Sample)
  
  return(df)
}

# all reads
read_bcerr(here("bcerror/T4_infected_ecoli.bcerror.tsv"), "infected") %>%
  mutate(BCerror = MismatchFreq + InsertionFreq + DeletionFreq) -> t4ecoli

read_bcerr(here("bcerror/T4_uninfected_ecoli.bcerror.tsv"), "uninfected") %>%
  mutate(BCerror = MismatchFreq + InsertionFreq + DeletionFreq) -> ecoli

bind_rows(t4ecoli, ecoli) -> all

read_tsv(here("ref/structural_alignments/unmodified/T4infectedecoli.seq2structure.tsv")) %>%
  rename(Position = seq_pos) %>%
  select(-struct_ref) %>%
  rename(Reference = seq_ref) -> mappings

left_join(all, mappings, by = c("Reference", "Position")) %>%
  select(-N_freq, -Position) %>%
  rename(Position = struct_pos) %>%
  filter(!is.na(Position)) %>% # this removes tRNAs that do not have structural info in the mappings df
  mutate(Position = Position -24) -> mapped # begin counting at the first nt of the tRNA body, not the adapter

# we can then optionally roll up some of this nuclear tRNA data by isodecoder family
# since there are no duplicate isodecoders in the phage reference these are easy
mapped %>%
  filter(str_starts(Reference, "phage")) %>%
  select(Reference, Spanning_Reads, Sample, BCerror, struct_nt, Position) %>%
  separate(Reference, into = c("Origin", "tRNA", "AA", "Anticodon"), sep = "-") %>%
  unite(Reference, c("Origin", "AA", "Anticodon"), sep = "-") %>%
  rename(Coverage = Spanning_Reads) %>%
  select(-tRNA, -struct_nt) -> phage_mapped

mapped %>%
  filter(str_starts(Reference, "host")) %>%
  select(Reference, Spanning_Reads, Sample, BCerror, struct_nt, Position) %>%
  separate(Reference, into = c("Origin", "tRNA", "AA", "Anticodon", "Family", "Species"), sep = "-") %>%
  group_by(Origin, tRNA, AA, Anticodon, Position, Sample) %>% # roll up to anticodon if not grouped by Family
  summarise(
    TotalCoverage = sum(Spanning_Reads),
    WeightedBCerror = sum(pmin(BCerror, 1) * Spanning_Reads) / sum(Spanning_Reads),  # Revised weighted average calculation
    .groups = "drop"
  ) %>%
  mutate(
    BCerror = ifelse(TotalCoverage > 0, WeightedBCerror, 0)
  ) %>%
  ungroup() %>%
  select(-BCerror) %>%
  rename(Coverage = TotalCoverage, BCerror = WeightedBCerror) %>%
  unite(Reference, c("Origin", "AA", "Anticodon"), sep = "-") %>%
  select(-tRNA) -> host_mapped

bind_rows(host_mapped, phage_mapped) -> test
```

Then take this structurally annotated data and widen it to enforce a coverage threshold and calculate bc error differences.
```{r}
test %>%
  select(Sample, Reference, Position, Coverage, BCerror) %>%
  pivot_wider(
    names_from = Sample,
    names_sep = "_",
    values_from = c(Coverage, BCerror)
  ) %>%
  mutate(
    MinCov = pmin(Coverage_uninfected, Coverage_infected, na.rm = TRUE),
    BCerror_infected = replace(BCerror_infected, MinCov < 29, 0),
    BCerror_uninfected = replace(BCerror_uninfected, MinCov < 29, 0),
    BC_delta = BCerror_infected - BCerror_uninfected) -> diffs


```
A plotting function for this structurally annotated basecalling error data.
```{r}
plot_basecalling_error <- function(data, title_suffix, include_legend = TRUE) {

    # 99 custom x-axis labels for consensus tRNA secondary structure
  x_labels <- c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", 
                "17a", "18", "19", "20", "20a", "20b", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", 
                "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", 
                "e11", "e12", "e13", "e14", "e15", "e16", "e17", "e1", "e2", "e3", "e4", "e5", 
                "e27", "e26", "e25", "e24", "e23", "e22", "e21", "49", "50", "51", "52", "53", "54", "55", "56", "57", 
                "58", "59", "60", "61", "62", "63", "64", "65", "66", "67", "68", "69", "70", "71", "72", "73")


 # Adjusted to filter for positions within the x_labels range if necessary
  max_position <- length(x_labels) # Assuming your positions match the length of x_labels
  
  filtered_data <- data %>%
    filter(Position >= -max_position, Position <= max_position) %>%
    mutate(Reference = fct_rev(as.factor(Reference)),
           Position = factor(Position, levels = -max_position:max_position))

  # plot
  p <- ggplot(filtered_data, aes(x = Position, y = BC_delta, fill = Reference)) +
    geom_tile(color = "white", size = 0.1) +
    scale_fill_gradient2(low = "#0072B2", high = "#D55E00", mid = "white", midpoint = 0, limits = c(-1, 1), na.value = "#D3D3D3") +
    scale_x_discrete(labels = x_labels) +
    labs(fill = "âˆ† BC error \n(Infected - Uninfected)",
         title = paste("Basecalling error changes", title_suffix),
         x = "",
         y = "BC Delta") +
    theme_cowplot() +
    theme(
      axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3, size = 10),
      legend.position = ifelse(include_legend, "bottom", "none")
    ) +
    coord_fixed(ratio = 1) # Ensure square tiles if that's desired

  return(p)
}
```
Make plots.
```{r}
plot_basecalling_error <- function(data, title_suffix, include_legend = TRUE) {
  library(ggplot2)
  library(dplyr)
  library(forcats) # For fct_rev

  # Custom x-axis labels for consensus tRNA secondary structure
  x_labels <- c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", 
                "17a", "18", "19", "20", "20a", "20b", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", 
                "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", 
                "e11", "e12", "e13", "e14", "e15", "e16", "e17", "e1", "e2", "e3", "e4", "e5", 
                "e27", "e26", "e25", "e24", "e23", "e22", "e21", "49", "50", "51", "52", "53", "54", "55", "56", "57", 
                "58", "59", "60", "61", "62", "63", "64", "65", "66", "67", "68", "69", "70", "71", "72", "73")

  # Filter and prepare the dataset
  data <- data %>%
    mutate(Position = factor(as.numeric(Position), levels = 1:96), # Ensure Position is a factor with correct levels
           Reference = fct_rev(as.factor(Reference))) # Reverse the factor levels of Reference

  # Creating a complete grid of Positions for each Reference
  complete_grid <- expand.grid(Position = levels(data$Position), Reference = levels(data$Reference))

  # Left join with the filtered dataset
  full_data <- complete_grid %>%
    left_join(data, by = c("Position", "Reference"))

  # Plot
  p <- ggplot(full_data, aes(x = Position, y = Reference, fill = BC_delta)) +
    geom_tile(color = "white", size = 0.1) +
    scale_fill_gradient2(low = "#0072B2", high = "#D55E00", mid = "white", midpoint = 0, na.value = "#D3D3D3") +
    scale_x_discrete(labels = x_labels) + # Apply custom x-axis labels
    labs(title = paste("Difference in basecalling error", title_suffix),
         x = "Position",
         y = "Reference") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 6),
          legend.position = ifelse(include_legend, "bottom", "none"))

  return(p)
}

diffs %>%
  filter(str_starts(Reference, "host")) %>%
  mutate(Reference = str_replace(Reference, "^host-", "")) -> diffs

plot_basecalling_error(diffs, "for E. coli tRNAs on T4 phage infection")
```

